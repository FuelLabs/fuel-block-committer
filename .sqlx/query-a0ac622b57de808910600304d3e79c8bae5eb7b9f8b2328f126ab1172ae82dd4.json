{
  "db_name": "PostgreSQL",
  "query": "\n            WITH\n\n            -- Step 1: Delete from l1_blob_transaction\n            deleted_blob_transactions AS (\n                DELETE FROM l1_blob_transaction\n                WHERE created_at < $1\n                RETURNING id\n            ),\n\n            -- Step 2: Delete from l1_transaction_fragments and collect fragment_ids\n            deleted_transaction_fragments AS (\n                DELETE FROM l1_transaction_fragments\n                WHERE transaction_id IN (SELECT id FROM deleted_blob_transactions)\n                RETURNING fragment_id\n            ),\n\n            -- Step 3: Delete unreferenced fragments and collect bundle IDs\n            deleted_fragments AS (\n                DELETE FROM l1_fragments\n                WHERE id IN (SELECT fragment_id FROM deleted_transaction_fragments)\n                RETURNING id\n            ),\n\n            -- Step 4: Build updated_fragments that represent the state of l1_fragments after deletions\n            updated_fragments AS (\n                SELECT bundle_id FROM l1_fragments\n                WHERE id NOT IN (SELECT id FROM deleted_fragments)\n            ),\n\n            -- Step 5: Delete unreferenced bundles and collect start and end heights\n            deleted_bundles AS (\n                DELETE FROM bundles\n                WHERE id NOT IN (SELECT bundle_id FROM updated_fragments)\n                RETURNING start_height, end_height\n            ),\n\n            -- Step 6: Delete corresponding fuel_blocks entries\n            deleted_fuel_blocks AS (\n                DELETE FROM fuel_blocks\n                WHERE EXISTS (\n                    SELECT 1 FROM deleted_bundles\n                    WHERE fuel_blocks.height BETWEEN deleted_bundles.start_height AND deleted_bundles.end_height\n                )\n                RETURNING height\n            )\n\n            SELECT\n                (SELECT COUNT(*) FROM deleted_blob_transactions) AS deleted_blob_transactions,\n                (SELECT COUNT(*) FROM deleted_transaction_fragments) AS deleted_transaction_fragments,\n                (SELECT COUNT(*) FROM deleted_fragments) AS deleted_fragments,\n                (SELECT COUNT(*) FROM deleted_bundles) AS deleted_bundles,\n                (SELECT COUNT(*) FROM deleted_fuel_blocks) AS deleted_fuel_blocks;\n            ",
  "describe": {
    "columns": [
      {
        "ordinal": 0,
        "name": "deleted_blob_transactions",
        "type_info": "Int8"
      },
      {
        "ordinal": 1,
        "name": "deleted_transaction_fragments",
        "type_info": "Int8"
      },
      {
        "ordinal": 2,
        "name": "deleted_fragments",
        "type_info": "Int8"
      },
      {
        "ordinal": 3,
        "name": "deleted_bundles",
        "type_info": "Int8"
      },
      {
        "ordinal": 4,
        "name": "deleted_fuel_blocks",
        "type_info": "Int8"
      }
    ],
    "parameters": {
      "Left": [
        "Timestamptz"
      ]
    },
    "nullable": [
      null,
      null,
      null,
      null,
      null
    ]
  },
  "hash": "a0ac622b57de808910600304d3e79c8bae5eb7b9f8b2328f126ab1172ae82dd4"
}
